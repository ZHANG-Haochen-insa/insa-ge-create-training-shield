# STM32 åŠŸç‡è®¡æµ‹è¯•å¼€å‘æ¿é¡¹ç›®æ–‡æ¡£

## é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æ˜¯åŸºäº **STM32L053R8T6** å¾®æ§åˆ¶å™¨çš„åŠŸç‡è®¡æµ‹è¯•å¼€å‘æ¿ï¼Œä¸ºåç»­ç”Ÿäº§ç‰ˆæœ¬ï¼ˆSTM32L052K6T6ï¼‰çš„SDKå¼€å‘æä¾›æµ‹è¯•å¹³å°ã€‚

### è®¾è®¡ç†å¿µ
**æµ‹è¯•å¼€å‘æ¿çš„æ ¸å¿ƒç‰¹æ€§**ï¼šä½¿ç”¨ **ä¸¤ä¸ªç”µä½å™¨æ—‹é’®** æ¥æ¨¡æ‹ŸçœŸå®çš„ç”µå‹å’Œç”µæµè¾“å…¥ä¿¡å·ï¼Œè¿™æ ·å¯ä»¥åœ¨æ²¡æœ‰å®é™…ç”µæºè´Ÿè½½çš„æƒ…å†µä¸‹ï¼Œå®Œæ•´æµ‹è¯•åŠŸç‡è®¡çš„æ‰€æœ‰è½¯ä»¶åŠŸèƒ½ã€‚

- **POT_1 (PC0/ADC_CH10)**: æ¨¡æ‹Ÿç”µå‹è¾“å…¥ (0-3.3V ADCè¾“å…¥ â†’ æ˜ å°„åˆ° 0-30V æ˜¾ç¤º)
- **POT_2 (PC1/ADC_CH11)**: æ¨¡æ‹Ÿç”µæµè¾“å…¥ (0-3.3V ADCè¾“å…¥ â†’ æ˜ å°„åˆ° 0-5A æ˜¾ç¤º)

è¿™ç§è®¾è®¡è®©å¼€å‘è€…èƒ½å¤Ÿï¼š
1. å®‰å…¨åœ°æµ‹è¯•æ‰€æœ‰åŠŸç‡è®¡ç®—åŠŸèƒ½ï¼ˆæ— éœ€çœŸå®é«˜åŠŸç‡ç”µè·¯ï¼‰
2. ç²¾ç¡®æ§åˆ¶è¾“å…¥å‚æ•°è¿›è¡Œç®—æ³•éªŒè¯
3. å®Œæ•´éªŒè¯ç”¨æˆ·ç•Œé¢å’Œæ•°æ®å¤„ç†é€»è¾‘
4. ä¸ºç”Ÿäº§ç‰ˆæœ¬æä¾›ç»è¿‡å……åˆ†æµ‹è¯•çš„è½¯ä»¶æ¡†æ¶

## ç¡¬ä»¶å¹³å°å¯¹æ¯”

### æµ‹è¯•å¼€å‘æ¿ vs ç”Ÿäº§ç‰ˆæœ¬

| ç‰¹æ€§ | æµ‹è¯•å¼€å‘æ¿ (å½“å‰) | ç”Ÿäº§ç‰ˆæœ¬ (ç›®æ ‡) |
|------|-----------------|----------------|
| **å¾®æ§åˆ¶å™¨** | STM32L053R8T6 | STM32L052K6T6 |
| **å°è£…** | LQFP64 | LQFP32 |
| **Flash** | 64KB | 32KB |
| **RAM** | 8KB | 8KB |
| **å¼•è„šæ•°** | 64å¼•è„š | 32å¼•è„š |
| **ADCé€šé“** | PC0/PC1 (CH10/11) - ç”µä½å™¨æ¨¡æ‹Ÿ | PA3/PA4 (CH3/4) - çœŸå®ç”µå‹/ç”µæµ |
| **I2Cæ¥å£** | PB8/PB9 (I2C1) | PB6/PB7 (I2C1) |
| **ç”¨æˆ·æŒ‰é’®** | PA4 | PB3 |
| **æ—‹è½¬ç¼–ç å™¨** | PA0/PA1 | PB4/PB5 |
| **OLEDæ˜¾ç¤ºå±** | 128x32 SSD1306 | 128x32 SSD1306 |

## å½“å‰å®ç°åŠŸèƒ½

### âœ… å·²å®ç°åŠŸèƒ½ (æµ‹è¯•å¼€å‘æ¿)
1. **æ¨¡æ‹Ÿè¾“å…¥ç³»ç»Ÿ**
   - **åŒç”µä½å™¨æ¨¡æ‹Ÿ**: POT_1æ¨¡æ‹Ÿç”µå‹ï¼ŒPOT_2æ¨¡æ‹Ÿç”µæµ
   - **ADCåŒé€šé“é‡‡é›†**: 12ä½ç²¾åº¦ (0-4095 â†’ æ˜ å°„åˆ°å®é™…é‡ç¨‹)
   - **å®æ—¶æ•°æ®æ›´æ–°**: 10Hzåˆ·æ–°ç‡
   - **å®šæ—¶å™¨ä¸­æ–­é©±åŠ¨**: TIM6, 100mså‘¨æœŸ
   - **å½“å‰æ˜¾ç¤ºæ ¼å¼**:
     ```
     P1:nnnn   P2:nnnn    (åŸå§‹ADCå€¼)
     ROT:nnn SWITCH:ON/OFF
     ```

2. **äººæœºäº¤äº’ç•Œé¢**
   - **SSD1306 OLEDæ˜¾ç¤ºå±é©±åŠ¨**: 128x32åƒç´ 
   - **æ—‹è½¬ç¼–ç å™¨**: æ­£äº¤è§£ç  (å››çŠ¶æ€) + 5msæ¶ˆæŠ–
   - **ç”¨æˆ·æŒ‰é’®**: ä¸­æ–­å¤„ç† (ä¸Šå‡/ä¸‹é™æ²¿)
   - **å®æ—¶å“åº”**: æ‰€æœ‰è¾“å…¥è®¾å¤‡çŠ¶æ€å®æ—¶æ˜¾ç¤º

3. **ç³»ç»Ÿæ¶æ„**
   - **ä¸­æ–­é©±åŠ¨æ¶æ„**: ä¸»å¾ªç¯ç©ºé—²ï¼Œæ‰€æœ‰åŠŸèƒ½é€šè¿‡ä¸­æ–­å®ç°
   - **æ¨¡å—åŒ–è®¾è®¡**: SSD1306é©±åŠ¨å®Œå…¨ç‹¬ç«‹
   - **HALåº“é›†æˆ**: æ ‡å‡†STM32 HALåº“
   - **é”™è¯¯å¤„ç†æœºåˆ¶**: Error_Handler()ç»Ÿä¸€å¤„ç†

4. **æµ‹è¯•å’ŒéªŒè¯åŠŸèƒ½**
   - **SSD1306æµ‹è¯•å¥—ä»¶**: å®Œæ•´çš„æ˜¾ç¤ºåŠŸèƒ½æµ‹è¯•
   - **ADCé‡‡é›†éªŒè¯**: é€šè¿‡æ—‹è½¬ç”µä½å™¨éªŒè¯ADCç²¾åº¦
   - **ç”¨æˆ·äº¤äº’æµ‹è¯•**: ç¼–ç å™¨å’ŒæŒ‰é’®å“åº”æµ‹è¯•

### ğŸš§ å¾…å¼€å‘åŠŸèƒ½ (å¯¹ç…§éœ€æ±‚æ–‡æ¡£)

#### æ ¸å¿ƒåŠŸç‡è®¡ç®—åŠŸèƒ½ (æ¨¡æ‹Ÿç¯å¢ƒ)
- [ ] **ADCå€¼æ˜ å°„ç®—æ³•**: 
  - POT_1 (0-4095) â†’ ç”µå‹æ˜¾ç¤º (0-30V)
  - POT_2 (0-4095) â†’ ç”µæµæ˜¾ç¤º (0-5A)
- [ ] **æ¨¡æ‹ŸåŠŸç‡è®¡ç®—**: P = V_simulated Ã— I_simulated
- [ ] **èƒ½é‡ç´¯ç§¯è®¡ç®—**: E = âˆ«PÂ·dt (åŸºäºæ¨¡æ‹ŸåŠŸç‡)
- [ ] **å³°å€¼è®°å½•**: Vmax, Imax, Pmax (æ¨¡æ‹Ÿå€¼)
- [ ] **æ ¡å‡†åŠŸèƒ½**: ç”µä½å™¨åˆ°å®é™…é‡ç¨‹çš„æ˜ å°„æ ¡å‡†

#### èœå•ç³»ç»Ÿå’Œç”¨æˆ·ç•Œé¢
- [ ] **å¤šçº§èœå•ç³»ç»Ÿ**: ä¸»èœå• â†’ å­èœå•å¯¼èˆª
- [ ] **åŠŸèƒ½é€‰æ‹©ç•Œé¢**: æµ‹é‡/æ˜¾ç¤º/å­˜å‚¨/é€šä¿¡/è®¾ç½®
- [ ] **å‚æ•°é…ç½®ç•Œé¢**: é‡ç¨‹è®¾ç½®ã€é‡‡æ ·ç‡è°ƒèŠ‚
- [ ] **æŒ‰é’®æ“ä½œé€»è¾‘**: çŸ­æŒ‰ç¡®è®¤ã€é•¿æŒ‰è¿”å›

#### æ˜¾ç¤ºåŠŸèƒ½å¢å¼º
- [ ] **åŠŸç‡è®¡æ¨¡å¼æ˜¾ç¤º**:
  ```
  V: 12.5V  I: 2.35A
  P: 29.4W  E: 1.234kWh
  ```
- [ ] **å›¾å½¢æ˜¾ç¤ºæ¨¡å¼**: å®æ—¶æ›²çº¿ç»˜åˆ¶ (åŸºäºæ¨¡æ‹Ÿè¾“å…¥)
- [ ] **å¤šå‚æ•°æ˜¾ç¤º**: V/I/PåŒæ—¶æ˜¾ç¤º
- [ ] **å•ä½è‡ªåŠ¨è°ƒæ•´**: V/mV, A/mA, W/mWåˆ‡æ¢

#### æ•°æ®å­˜å‚¨ç³»ç»Ÿ
- [ ] **RAMå¾ªç¯ç¼“å†²åŒº**: 1000æ¡è®°å½•å­˜å‚¨
- [ ] **Flashéæ˜“å¤±æ€§å­˜å‚¨**: æ•°æ®æŒä¹…åŒ–
- [ ] **ç»Ÿè®¡æ•°æ®è®¡ç®—**: å¹³å‡å€¼ã€æœ€å¤§å€¼ã€æœ€å°å€¼
- [ ] **æ•°æ®ç»“æ„å®šä¹‰**:
  ```c
  typedef struct {
      uint32_t timestamp;
      uint16_t voltage;
      uint16_t current; 
      uint16_t power;
  } MeasurementData;
  ```

#### é€šä¿¡åŠŸèƒ½
- [ ] **UART1ä¸²å£é€šä¿¡**: 115200æ³¢ç‰¹ç‡
- [ ] **å®æ—¶æ•°æ®ä¼ è¾“**: ASCIIåè®®æ ¼å¼
- [ ] **æ•°æ®å¯¼å‡ºåŠŸèƒ½**: å†å²æ•°æ®æ‰¹é‡ä¼ è¾“
- [ ] **PCç«¯é€šä¿¡åè®®**:
  ```
  $DATA,timestamp,voltage,current,power,energy\r\n
  $STAT,avg_v,avg_i,avg_p,total_e,runtime\r\n
  ```

## æŠ€æœ¯æ¶æ„

### å½“å‰è½¯ä»¶æ¶æ„
```
main.c
â”œâ”€â”€ Timer_Interrupt_Handler()     # TIM6ä¸­æ–­: ADCé‡‡é›† + æ˜¾ç¤ºæ›´æ–°
â”œâ”€â”€ User_Button_Interrupt_Handler()  # æŒ‰é’®çŠ¶æ€å¤„ç†
â”œâ”€â”€ Rotary_Encoder_Interrupt_Handler()  # ç¼–ç å™¨è§£ç 
â””â”€â”€ Get_ADC_Value()              # ADCé‡‡é›†å‡½æ•°

ssd1306/
â”œâ”€â”€ ssd1306.c/h                  # æ˜¾ç¤ºé©±åŠ¨æ ¸å¿ƒ
â”œâ”€â”€ ssd1306_fonts.c/h            # å­—ä½“åº“ 
â””â”€â”€ ssd1306_tests.c/h            # æµ‹è¯•åŠŸèƒ½
```

### ç›®æ ‡è½¯ä»¶æ¶æ„ (éœ€å¼€å‘)
```
åº”ç”¨å±‚ (App Layer)
â”œâ”€â”€ menu_system.c                # èœå•ç³»ç»Ÿ
â”œâ”€â”€ power_meter.c                # åŠŸç‡è®¡ç®—å¼•æ“
â”œâ”€â”€ data_storage.c               # æ•°æ®å­˜å‚¨ç®¡ç†
â””â”€â”€ communication.c              # é€šä¿¡åè®®

ä¸­é—´å±‚ (Middleware)
â”œâ”€â”€ display_manager.c            # æ˜¾ç¤ºç®¡ç†å™¨
â”œâ”€â”€ input_handler.c              # ç”¨æˆ·è¾“å…¥å¤„ç†
â””â”€â”€ system_config.c              # ç³»ç»Ÿé…ç½®

ç¡¬ä»¶æŠ½è±¡å±‚ (HAL)
â”œâ”€â”€ adc_driver.c                 # ADCé©±åŠ¨å°è£…
â”œâ”€â”€ flash_storage.c              # Flashå­˜å‚¨é©±åŠ¨
â””â”€â”€ uart_communication.c         # UARTé€šä¿¡é©±åŠ¨
```

## å¼€å‘ç¯å¢ƒ

### å·¥å…·é“¾
- **IDE**: STM32CubeIDE 1.18.1
- **å·¥å…·é“¾**: GNU Tools for STM32 (13.3.rel1)
- **è°ƒè¯•å™¨**: ST-Link V2
- **é…ç½®å·¥å…·**: STM32CubeMX 6.14.0

### ç¼–è¯‘é…ç½®
```bash
# æ„å»ºå‘½ä»¤
make -C Debug clean
make -C Debug all

# è°ƒè¯•å‘½ä»¤  
# ä½¿ç”¨STM32CubeIDE: Run â†’ Debug (F11)
```

### å†…å­˜é…ç½®
- **Flashä½¿ç”¨**: çº¦20KB (å‰©ä½™44KBå¯ç”¨)
- **RAMåˆ†é…**:
  - ç³»ç»Ÿæ ˆ: 1KB
  - ç³»ç»Ÿå †: 512B  
  - å…¨å±€å˜é‡: ~2KB
  - æ•°æ®ç¼“å†²åŒº: ~4KB (å¾…å®ç°)

## å…³é”®æŠ€æœ¯å®ç°

### ADCæ¨¡æ‹Ÿè¾“å…¥ç³»ç»Ÿ
```c
// å½“å‰å®ç°: æ”¯æŒä»»æ„é€šé“åˆ‡æ¢ï¼Œä¸“é—¨ç”¨äºç”µä½å™¨æ¨¡æ‹Ÿ
uint32_t Get_ADC_Value(uint32_t adc_channel) {
    hadc.Instance->CHSELR = 0;  // æ¸…é™¤é€šé“é…ç½®
    ADC_ChannelConfTypeDef sConfig = {0};
    sConfig.Channel = adc_channel;
    sConfig.Rank = ADC_RANK_CHANNEL_NUMBER;
    HAL_ADC_ConfigChannel(&hadc, &sConfig);
    HAL_ADC_Start(&hadc);
    HAL_ADC_PollForConversion(&hadc, 100);
    return HAL_ADC_GetValue(&hadc);
}

// å¾…å®ç°: ADCå€¼åˆ°å®é™…ç‰©ç†é‡çš„æ˜ å°„
float Convert_ADC_to_Voltage(uint32_t adc_value) {
    // ADC_CHANNEL_10 (POT_1): 0-4095 â†’ 0-30V
    return (float)adc_value * 30.0f / 4095.0f;
}

float Convert_ADC_to_Current(uint32_t adc_value) {
    // ADC_CHANNEL_11 (POT_2): 0-4095 â†’ 0-5A  
    return (float)adc_value * 5.0f / 4095.0f;
}
```

### æ—‹è½¬ç¼–ç å™¨è§£ç 
```c
// å››çŠ¶æ€æ­£äº¤è§£ç å®ç°
void Rotary_Encoder_Interrupt_Handler(void) {
    static int8_t rotary_buffer = 0;
    HAL_Delay(5);  // 5msæ¶ˆæŠ–
    uint8_t rotary_new = HAL_GPIO_ReadPin(ROT_CHA_GPIO_Port, ROT_CHA_Pin) << 1;
    rotary_new += HAL_GPIO_ReadPin(ROT_CHB_GPIO_Port, ROT_CHB_Pin);
    
    // çŠ¶æ€æœºè§£ç é€»è¾‘
    if (/* é¡ºæ—¶é’ˆæ£€æµ‹ */) rotary_buffer++;
    if (/* é€†æ—¶é’ˆæ£€æµ‹ */) rotary_buffer--;
    
    // ç¼“å†²åŒºå¤„ç† (Â±4è®¡æ•°å¹³æ»‘)
    if (rotary_buffer > 3) { rotary_counter++; rotary_buffer = 0; }
    if (rotary_buffer < -3) { rotary_counter--; rotary_buffer = 0; }
}
```

## å¼€å‘è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µ: æ¨¡æ‹ŸåŠŸç‡è®¡ç®—æ ¸å¿ƒ (2å‘¨)
1. å®ç°ADCåˆ°ç‰©ç†é‡çš„æ˜ å°„ç®—æ³• (ç”µä½å™¨ â†’ V/I)
2. æ¨¡æ‹ŸåŠŸç‡è®¡ç®— P = V_sim Ã— I_sim
3. èƒ½é‡ç´¯ç§¯ç®—æ³• E = âˆ«PÂ·dt (åŸºäºæ¨¡æ‹ŸåŠŸç‡)
4. å³°å€¼æ£€æµ‹å’Œè®°å½• (æ¨¡æ‹Ÿç¯å¢ƒä¸‹)

### ç¬¬äºŒé˜¶æ®µ: èœå•ç³»ç»Ÿ (2å‘¨)  
1. å¤šçº§èœå•æ¡†æ¶
2. ç”¨æˆ·è¾“å…¥å¤„ç†ä¼˜åŒ–
3. æ˜¾ç¤ºæ¨¡å¼åˆ‡æ¢ (æ•°å€¼/å›¾å½¢)
4. å‚æ•°é…ç½®ç•Œé¢

### ç¬¬ä¸‰é˜¶æ®µ: æ•°æ®å­˜å‚¨ (2å‘¨)
1. RAMå¾ªç¯ç¼“å†²åŒºå®ç°
2. Flashå­˜å‚¨ç³»ç»Ÿ
3. ç»Ÿè®¡æ•°æ®è®¡ç®—
4. æ•°æ®å¯¼å‡ºåŠŸèƒ½

### ç¬¬å››é˜¶æ®µ: é€šä¿¡ç³»ç»Ÿ (2å‘¨)
1. UARTé€šä¿¡åè®®
2. å®æ—¶æ•°æ®ä¼ è¾“
3. PCç«¯å·¥å…·å¼€å‘ (å¯é€‰)
4. ç³»ç»Ÿé›†æˆæµ‹è¯•

## ç§»æ¤æ³¨æ„äº‹é¡¹

### ä»æµ‹è¯•æ¿åˆ°ç”Ÿäº§ç‰ˆæœ¬çš„é€‚é…
1. **å¼•è„šé‡æ˜ å°„**:
   ```c
   // æµ‹è¯•æ¿ â†’ ç”Ÿäº§ç‰ˆ
   ADC_CHANNEL_10 â†’ ADC_CHANNEL_3   // PC0 â†’ PA3 (ç”µä½å™¨æ¨¡æ‹Ÿ â†’ çœŸå®ç”µå‹)
   ADC_CHANNEL_11 â†’ ADC_CHANNEL_4   // PC1 â†’ PA4 (ç”µä½å™¨æ¨¡æ‹Ÿ â†’ çœŸå®ç”µæµ)
   I2C1_SCL: PB8 â†’ PB6
   I2C1_SDA: PB9 â†’ PB7
   USER_BUTTON: PA4 â†’ PB3
   ```

2. **è¾“å…¥ä¿¡å·å¤„ç†å·®å¼‚**:
   - **æµ‹è¯•æ¿**: ç”µä½å™¨ç›´æ¥ADCè¾“å…¥ (0-3.3Vçº¿æ€§)
   - **ç”Ÿäº§ç‰ˆ**: çœŸå®ç”µå‹/ç”µæµä¿¡å·è°ƒç†ç”µè·¯è¾“å…¥
   - **æ˜ å°„ç®—æ³•**: ä¿æŒç›¸åŒçš„è½¯ä»¶æ¥å£ï¼Œåªä¿®æ”¹åº•å±‚è½¬æ¢ç³»æ•°

3. **Flashå®¹é‡ä¼˜åŒ–**: ä»64KBé€‚é…åˆ°32KB
   - ä»£ç ä¼˜åŒ–å’Œå‹ç¼©
   - ç§»é™¤è°ƒè¯•ä¿¡æ¯å’Œæµ‹è¯•åŠŸèƒ½
   - ç²¾ç®€å­—ä½“åº“ (ä¿ç•™æ ¸å¿ƒæ˜¾ç¤ºåŠŸèƒ½)

4. **I2Cåœ°å€è°ƒæ•´**: ç¡®è®¤ç”Ÿäº§ç‰ˆOLEDåœ°å€(0x3C vs 0x78)

## éªŒè¯å’Œæµ‹è¯•

### åŠŸèƒ½æµ‹è¯• (æ¨¡æ‹Ÿç¯å¢ƒ)
- [ ] **ç”µä½å™¨çº¿æ€§åº¦æµ‹è¯•**: éªŒè¯ADCè¯»æ•°ä¸æ—‹é’®ä½ç½®çš„çº¿æ€§å…³ç³»
- [ ] **æ˜ å°„ç®—æ³•ç²¾åº¦æµ‹è¯•**: ADCå€¼åˆ°V/Içš„è½¬æ¢ç²¾åº¦ (Â±1%è¯¯å·®)
- [ ] **æ¨¡æ‹ŸåŠŸç‡è®¡ç®—éªŒè¯**: P = V_sim Ã— I_sim çš„è®¡ç®—å‡†ç¡®æ€§
- [ ] **é•¿æ—¶é—´ç¨³å®šæ€§æµ‹è¯•**: è¿ç»­24å°æ—¶æ¨¡æ‹Ÿè¿è¡Œ
- [ ] **ç”¨æˆ·äº¤äº’å®Œæ•´æ€§**: æ‰€æœ‰æŒ‰é’®å’Œç¼–ç å™¨åŠŸèƒ½æµ‹è¯•

### æ€§èƒ½æµ‹è¯•  
- [ ] å“åº”æ—¶é—´æµ‹è¯• (<100ms)
- [ ] å†…å­˜ä½¿ç”¨æµ‹è¯•
- [ ] åŠŸè€—æµ‹è¯• (<100mA)

### å…¼å®¹æ€§æµ‹è¯•
- [ ] ç”Ÿäº§ç‰ˆæœ¬ç§»æ¤éªŒè¯
- [ ] ä¸åŒOLEDæ˜¾ç¤ºå±æµ‹è¯•
- [ ] é€šä¿¡åè®®å…¼å®¹æ€§æµ‹è¯•

## é¡¹ç›®çŠ¶æ€

**å½“å‰ç‰ˆæœ¬**: v0.1.0 (åŸºç¡€æ¡†æ¶)  
**ç›®æ ‡ç‰ˆæœ¬**: v1.0.0 (å®Œæ•´åŠŸç‡è®¡)  
**é¢„è®¡å®Œæˆ**: 8-10å‘¨  

**é£é™©è¯„ä¼°**:
- ğŸŸ¡ Flashå®¹é‡é™åˆ¶ (32KBç”Ÿäº§ç‰ˆ)
- ğŸŸ¡ ADCç²¾åº¦å’Œæ¸©åº¦è¡¥å¿
- ğŸŸ¢ åŸºç¡€æ¡†æ¶å·²ç¨³å®š
- ğŸŸ¢ æ˜¾ç¤ºå’Œäº¤äº’ç³»ç»Ÿæˆç†Ÿ